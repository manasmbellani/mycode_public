#!/bin/bash
SCRIPT_DIR=$(dirname "$0")
USAGE="$0 <seed_domains> <seed_ips> [virustotal_key=$VIRUSTOTAL_KEY] [shodan_key=$SHODAN_KEYS]"
SUBDOMAIN_REGEX="[^/]+"
DOMAIN_REGEX="^[a-zA-Z0-9\.\-]+\.[a-zA-Z0-9\.\-]{2,6}$"
CDN_DOMAINS_EXCLUSIONS="in-cdn-domains.txt"
TIMEOUT=300

function verbose {
    msg="$1"
    echo "[*] $msg"
}

if [ $# -lt 2 ]; then
    echo "[-] $USAGE"
    exit 1
fi
seed_domains="$1"
seed_ips="$2"
virustotal_key=${3:-"$VIRUSTOTAL_KEY"}
shodan_key=${4:-"$SHODAN_KEY"}

verbose "Reading seed domains from seeds: $seed_domains..."
if [ -f "$seed_domains" ]; then
    seed_domains=$(cat "$seed_domains" | grep -ioE "$DOMAIN_REGEX")
else
    seed_domains=$(echo "$seed_domains" | tr -s "," "\n" | grep -ioE "$DOMAIN_REGEX")
fi

verbose "Reading seed IPs from seeds: $seed_ips..."
if [ -f "$seed_ips" ]; then
    seed_ips=$(cat "$seed_ips" | grep -ioE "$DOMAIN_REGEX")
else
    seed_ips=$(echo "$seed_ips" | tr -s "," "\n" | grep -ioE "$DOMAIN_REGEX")
fi


# Set virustotal key for assetfinder
if [ ! -z "$virustotal_key" ]; then
    export VIRUSTOTAL_KEY="$virustotal_key"
fi

# Clearing all output files
rm out-* 2>/dev/null

verbose "Adding seed domains themselves as potential domains..."
echo "$seed_domains"  | /root/go/bin/anew -q "out-domains.txt"

num_seed_domains=$(echo "$seed_domains" | wc -l)
IFS=$'\n'; i=0
for seed_domain in $seed_domains; do
    i=$(($i + 1))
    echo "[*] $i / $num_seed_domains: Invoking a recon using hakrawler on seed: $seed_domain..."
    echo "https://$seed_domain" | /root/go/bin/hakrawler -subs | grep -ioE "$SUBDOMAIN_REGEX.$seed_domain" | /root/go/bin/anew -q "out-domains.txt"

    echo "[*] $i / $num_seed_domains: Invoking a recon using assetfinder on seed: $seed_domain..."
    /root/go/bin/assetfinder --subs-only "$seed_domain" | grep -ioE "$SUBDOMAIN_REGEX.$seed_domain" | /root/go/bin/anew -q "out-domains.txt"
done

verbose "Identifying resolvable domains from out-domains.txt..."
    cat "out-domains.txt"  | /root/go/bin/dnsx -silent -a -resp -nc > "out-dns-resolutions-domains.txt"
cat "out-dns-resolutions-domains.txt" | cut -d " " -f1 | sort | uniq > "out-resolvable-domains.txt"
cat "out-dns-resolutions-domains.txt" | cut -d "[" -f3 | cut -d "]" -f1 | sort | uniq > "out-resolvable-ips.txt"

verbose "Identifying CDN domains from out-domains.txt..."
cat "out-domains.txt" | /root/go/bin/cdncheck -resp -nc -silent | grep -iE '\[cdn\]|\[waf\]|\[cloud\]' | cut -d " " -f1 > "out-cdn-domains.txt"

verbose "Identifying resolvable, non-CDN domains from out-cdn-domains.txt..."
grep -Fxv -f "out-cdn-domains.txt"  "out-resolvable-domains.txt" > "out-noncdn-domains-intermediate.txt"

verbose "Identify if there are domains manually excluded from out-noncdn-domains-intermediate.txt..."
grep -Fxv -f "$CDN_DOMAINS_EXCLUSIONS" "out-noncdn-domains-intermediate.txt"  > "out-noncdn-domains.txt"

verbose "Combining seed IPs for port scanning..."
(echo "$seed_ips"; echo "$seed_domains") | sort | uniq > "out-all-ips.txt"

num_all_ips=$(cat "out-all-ips.txt" | wc -l)
verbose "Running nmap port scan for $num_all_ips IPs ..."
nmap --stats-every=2s -sS -sV -Pn --open "$d" -iL "out-all-ips.txt" -oG /tmp/out.txt
cat /tmp/out.txt  |  grep -ioE "Host:.*(Status|Ports):.*" > "out-nmap-tcp.txt"

verbose "Get HTTP IPs..."
cat "out-nmap-tcp.txt" | grep -iE "open/tcp/.*/(http|ssl)/" | tr -d '\t' > "out-http-lines.txt"

verbose "Get HTTP Domains and ports to scan.."
IFS=$'\n'
for l in $(cat "out-http-lines.txt"); do
    ports=$(echo "$l" | grep -ioE "[0-9]+/open/tcp//(http|ssl)" | cut -d "/" -f1)
    ipaddr=$(echo "$l" | cut -d " " -f2)
    hostnames=$(grep "$ipaddr" "out-dns-resolutions-domains.txt" | cut -d " " -f1)
    if [ -z "$hostnames" ]; then
        hostnames="$ipaddr"
    fi
    hostname_port_combos=""
    IFS=$'\n'
    for hostname in $hostnames; do
        for port in $ports; do
            if [[ $port =~ .*80 ]]; then
                echo "http://$hostname:$port" >> "out-http-hostnames-ports.txt"
            else
                echo "https://$hostname:$port" >> "out-http-hostnames-ports.txt"
            fi
        done
    done
done 

echo "Getting unique rows for scanning..."
cat "out-http-hostnames-ports.txt" |  sort | uniq > /tmp/out.txt
mv /tmp/out.txt "out-http-hostnames-ports.txt"

verbose "Scanning HTTP Domains and ports with webtech.."
source /opt/webtech/venv/bin/activate
IFS=$'\n'
for combo in $(cat "out-http-hostnames-ports.txt"); do 
    verbose "Scanning $combo with webtech..."
    webtech -u "$combo" --rua --og >> "out-http-webtech.txt"
done
deactivate
