#!/bin/bash

echo "[*] Loading setup.secrets.env..."
source "setup.secrets.env"

echo "[*] Installing dependencies..."
sudo apt-get -y update && 
sudo apt-get -y install \
    nmap \
    nano \
    curl \
    sudo \
    git \
    python3 \
    python3-virtualenv \
    p7zip-full \
    net-tools \
    man-db \
    nim \
    mingw-w64 \
    kali-desktop-xfce \
    xorg \
    xrdp \
    responder \
    nikto \
    metasploit-framework \
    sqlite3 \
    burpsuite

if [ ! -f "/opt/.flag-kali-change-password" ]; then
    if [ -f "setup.secrets.env" ]; then
        echo "[*] Changing password for user: $KALI_USERNAME..."
        echo "$KALI_USERNAME:$KALI_PASSWORD" | sudo chpasswd
        touch /opt/.flag-kali-change-password
    else
        echo "[-] setup.secrets.env file not found. Username/password to change to unknown."
    fi
fi

if [ ! -f "/root/go/bin/paramix" ]; then
    echo "[*] Installing paramix..."
    go install github.com/xhzeem/paramix@latest
fi


if [ ! -f "/root/go/bin/nuclei" ]; then
    echo "[*] Installing nuclei..."
    go install -v github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest

    echo "[*] Updating nuclei version..."
    /root/go/bin/nuclei -u

    echo "[*] Updating nuclei-templates..."
    /root/go/bin/nuclei -u -ut
fi

if [ ! -d "/opt/dirsearch" ]; then
    echo "[*] Installing dirsearch..."
    git clone https://github.com/maurosoria/dirsearch /opt/dirsearch
    cd /opt/dirsearch
    python3 -m virtualenv venv 
    source venv/bin/activate
    python3 -m pip install -r requirements.txt
    deactivate
fi

if [ ! -f "/root/go/bin/hakoriginfinder" ]; then
    echo "[*] Installing hakoriginfinder..."
    go install github.com/hakluke/hakoriginfinder@latest
fi


if [ ! -f "/root/go/bin/httpx" ]; then
    echo "[*] Installing httpx..."
    go install -v github.com/projectdiscovery/httpx/cmd/httpx@latest
fi

if [ ! -d "/opt/nvdsearch" ]; then
    echo "[*] Installing nvdsearch..."
    git clone https://github.com/optiv/nvdsearch /opt/nvdsearch
    cd /opt/nvdsearch
    go mod init nvdsearch
    go mod tidy
    go build
    mv nvdsearch /root/go/bin/
fi

if [ ! -f "/root/go/bin/katana" ]; then
    echo "[*] Installing katana..."
    curl -sL https://github.com/projectdiscovery/katana/releases/download/v1.0.3/katana_1.0.3_linux_amd64.zip -o /tmp/katana.zip
    cd /tmp
    yes | unzip /tmp/katana.zip
    mv katana /root/go/bin
    chmod +x /root/go/bin/katana
fi

if [ ! -d "/opt/mycode_public" ]; then
    echo "[*] Cloning mycode_public..."
    git clone https://github.com/manasmbellani/mycode_public /opt/mycode_public
fi

if [ ! -d "/opt/paramspider" ]; then
    echo "[*] Installing paramspider..."
    git clone https://github.com/devanshbatham/ParamSpider /opt/paramspider
    cd /opt/paramspider
    python3 -m virtualenv venv
    source venv/bin/activate
    python3 setup.py install
    deactivate
fi

if [ ! -f "/root/go/bin/xcrawl3r" ]; then
    echo "[*] Installing xcrawler..."
    curl -sL https://github.com/hueristiq/xcrawl3r/releases/download/0.1.0/xcrawl3r_0.1.0_linux_amd64.tar.gz -o /tmp/xcrawl3r.tar.gz
    cd /tmp
    tar xzvf /tmp/xcrawl3r.tar.gz
    mv xcrawl3r /root/go/bin/xcrawl3r
    rm /tmp/xcrawl3r.tar.gz
fi


if [ ! -d "/opt/openredirex" ]; then
    echo "[*] Installing openredirex..."
    git clone https://github.com/devanshbatham/openredirex /opt/openredirex
    cd /opt/openredirex
    python3 -m virtualenv venv
    python3 -m pip install tqdm aiohttp
    deactivate
fi
